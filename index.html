<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <title>신월동행 가챠 시뮬레이터</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="banner-selector"></div>
    <main>
      <div class="sidebar">
        <div class="banner-info">
          <div>
            <div class="banner-info__type"></div>
            <h2 class="banner-info__name"></h2>
          </div>
          <div class="stats-panel">
            <span style="font-weight: 700; padding-bottom: 6px;">통계</span>
            <div class="stats-panel__card">
              <span>누적 소모 월상석 가루</span>
              <div class="js-total-spent">
                <img src="./img/pqia4y.png" height="20px"> 0
              </div>
            </div>
            <hr class="stats-panel__divider">
            <div class="stats-panel__card js-stats-rotation">
              <span style="font-weight: 700; text-align: center;">교대 핫라인</span>
              <span>총 영입 횟수: 0</span>
              <span>6★: 0</span>
              <span>5★: 0</span>
              <span>4★: 0</span>
              <span>3★: 0</span>
            </div>
            <hr class="stats-panel__divider">
            <div class="stats-panel__card js-stats-permanent">
              <span style="font-weight: 700; text-align: center;">영구 핫라인</span>
              <span>총 영입 횟수: 0</span>
              <span>6★: 0</span>
              <span>5★: 0</span>
              <span>4★: 0</span>
              <span>3★: 0</span>
            </div>
          </div>
          <div class="stats-panel__actions">
            <button class="stats-panel__button js-show-history">통신 기록</button>
            <button class="stats-panel__button js-reset">초기화</button>
          </div>
        </div>
      </div>
      <div class="gacha-area">
        <div class="gacha-area__container">
          <div class="pity-tracker">
            <span class="js-pity-6">70회 확정: 6성 특수 요원 (픽업 특수 요원)</span>
            <span class="js-pity-5">10회 확정: 5성 이상의 특수 요원</span>
          </div>
          <div class="gacha-results">
            <div class="gacha-results__grid"></div>
          </div>
          <div class="draw-controls">
            <button class="draw-controls__button js-draw-1">
              영입 1회
              <div class="draw-controls__cost"><img src="./img/pqia4y.png" alt="월상석" height="16px">x160</div>
            </button>
            <button class="draw-controls__button js-draw-10">
              영입 10회
              <div class="draw-controls__cost"><img src="./img/pqia4y.png" alt="월상석" height="16px">x1600</div>
            </button>
          </div>
        </div>
      </div>
    </main>
    
    <div class="history-popup history-popup--closed">
      <div class="history-popup__content">
        <button class="history-popup__close-button">×</button>
        <div class="history-popup__list"></div>
      </div>
    </div>

    <script>
      let bannerData;
      let characterMap;

      let gachaState = {
        totalSpent: 0,
        history: [],
        stats: {
          "교대 핫라인": { total: 0, star6: 0, star5: 0, star4: 0, star3: 0 },
          "영구 핫라인": { total: 0, star6: 0, star5: 0, star4: 0, star3: 0 },
        },
        pity: {
          "교대 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
          "영구 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
        }
      };

      const loadState = () => {
        const savedState = localStorage.getItem('gachaState');
        if (savedState) {
            let loaded = JSON.parse(savedState);
            if (!loaded.pity) {
                loaded.pity = {
                    "교대 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
                    "영구 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
                };
            } else {
                for (const key in loaded.pity) {
                    if (loaded.pity[key].guaranteedPickup === undefined) {
                        loaded.pity[key].guaranteedPickup = false;
                    }
                }
            }
            gachaState = loaded;
        }
      };

      const saveState = () => {
        localStorage.setItem('gachaState', JSON.stringify(gachaState));
      };

      const updateStatsUI = () => {
        document.querySelector('.js-total-spent').innerHTML = `<img src="./img/pqia4y.png" height="20px"> ${gachaState.totalSpent}`;
        
        const rotationStats = gachaState.stats["교대 핫라인"];
        const rotationPanel = document.querySelector('.js-stats-rotation');
        rotationPanel.children[1].textContent = `총 영입 횟수: ${rotationStats.total}`;
        rotationPanel.children[2].textContent = `6★: ${rotationStats.star6}`;
        rotationPanel.children[3].textContent = `5★: ${rotationStats.star5}`;
        rotationPanel.children[4].textContent = `4★: ${rotationStats.star4}`;
        rotationPanel.children[5].textContent = `3★: ${rotationStats.star3}`;

        const permanentStats = gachaState.stats["영구 핫라인"];
        const permanentPanel = document.querySelector('.js-stats-permanent');
        permanentPanel.children[1].textContent = `총 영입 횟수: ${permanentStats.total}`;
        permanentPanel.children[2].textContent = `6★: ${permanentStats.star6}`;
        permanentPanel.children[3].textContent = `5★: ${permanentStats.star5}`;
        permanentPanel.children[4].textContent = `4★: ${permanentStats.star4}`;
        permanentPanel.children[5].textContent = `3★: ${permanentStats.star3}`;
      };

      const updatePityUI = (banner) => {
        if (!banner) return;
        const pityCounters = gachaState.pity[banner.type];
        const pity6El = document.querySelector('.js-pity-6');
        const pity5El = document.querySelector('.js-pity-5');
        
        const pullsTo6Star = 70 - pityCounters.pity6Star;
        const pullsTo5Star = 10 - pityCounters.pity5Star;

        let guaranteedText = (banner.pickup !== 0) ? " (픽업 특수 요원)" : "";
        pity6El.textContent = `${pullsTo6Star}회 후 6성 특수 요원${guaranteedText}`;
        pity5El.textContent = `${pullsTo5Star}회 후 5성 이상의 특수 요원`;
      };

      const displayResults = (results) => {
        const gachaContainer = document.querySelector('.gacha-results__grid');
        gachaContainer.innerHTML = '';
        
        results.forEach(char => {
          const charDiv = document.createElement('div');
          // Use modifier classes for rarity
          charDiv.className = `result-card result-card--star-${char.rare.replace('star', '')}`;
          
          const img = document.createElement('img');
          img.className = 'result-card__image';
          img.src = `./img/character/${char.id}/0.png`; 
          img.alt = char.name;

          const nameSpan = document.createElement('span');
          nameSpan.className = 'result-card__name';
          nameSpan.textContent = char.name;
          
          charDiv.appendChild(img);
          charDiv.appendChild(nameSpan);
          gachaContainer.appendChild(charDiv);
        });
      };

      const performSingleDraw = (banner, currentPity) => {
        const poolsByRarity = { star6: [], star5: [], star4: [], star3: [] };
        banner.pool.forEach(id => {
          const char = characterMap.get(id);
          if (char && poolsByRarity[char.rare]) {
            poolsByRarity[char.rare].push(id);
          }
        });

        let rarity;
        const pity5Threshold = (Math.random() < 0.02) ? 'star6' : 'star5'; // Standard banner rates on 10-pull pity
        if (currentPity.pity6Star >= 70) {
          rarity = 'star6';
        } else if (currentPity.pity5Star >= 10) {
          rarity = pity5Threshold;
        } else {
          const rand = Math.random() * 100;
          if (rand < banner.rates.star6) rarity = 'star6';
          else if (rand < banner.rates.star6 + banner.rates.star5) rarity = 'star5';
          else if (rand < banner.rates.star6 + banner.rates.star5 + banner.rates.star4) rarity = 'star4';
          else rarity = 'star3';
        }
        
        let finalCharId;
        const pickup = banner.pickup;
        const hasPickup = pickup && typeof pickup === 'object';

        if (rarity === 'star6' && hasPickup && pickup.star6) {
          if (currentPity.guaranteedPickup) {
            finalCharId = pickup.star6;
          } else {
            if (Math.random() < 0.5) {
              finalCharId = pickup.star6;
            } else {
              const nonPickupPool = poolsByRarity.star6.filter(id => id !== pickup.star6);
              finalCharId = nonPickupPool.length > 0 ? nonPickupPool[Math.floor(Math.random() * nonPickupPool.length)] : pickup.star6;
            }
          }
        } else if (rarity === 'star5' && hasPickup && pickup.star5 && pickup.star5.length > 0) {
          if (Math.random() < 0.5) {
            finalCharId = pickup.star5[Math.floor(Math.random() * pickup.star5.length)];
          } else {
            const nonPickupPool = poolsByRarity.star5.filter(id => !pickup.star5.includes(id));
            finalCharId = nonPickupPool.length > 0 ? nonPickupPool[Math.floor(Math.random() * nonPickupPool.length)] : pickup.star5[0];
          }
        } else {
          const targetPool = poolsByRarity[rarity];
          finalCharId = targetPool[Math.floor(Math.random() * targetPool.length)];
        }
        
        return characterMap.get(finalCharId) || { id: 0, name: '데이터 없음', rare: 'star3' };
      };

      const handleDraw = (count) => {
        const selectedBannerKey = localStorage.getItem('selectedBannerKey');
        if (!selectedBannerKey || !bannerData[selectedBannerKey]) {
          alert("배너를 먼저 선택해주세요.");
          return;
        }

        const banner = bannerData[selectedBannerKey];
        const pityCounters = gachaState.pity[banner.type];
        const results = [];
        
        for (let i = 0; i < count; i++) {
          pityCounters.pity5Star++;
          pityCounters.pity6Star++;
          
          const character = performSingleDraw(banner, pityCounters);
          results.push(character);
          
          const bannerTypeStats = gachaState.stats[banner.type];
          bannerTypeStats.total++;
          bannerTypeStats[character.rare]++;
          gachaState.totalSpent += 160;

          if (character.rare === 'star6') {
            pityCounters.pity5Star = 0;
            pityCounters.pity6Star = 0;

            const bannerPickupId = banner.pickup?.star6;
            if (bannerPickupId) {
              pityCounters.guaranteedPickup = character.id !== bannerPickupId;
            }
          } else if (character.rare === 'star5') {
            pityCounters.pity5Star = 0;
          }
        }
        
        gachaState.history.unshift(...results.map(char => ({ ...char, banner: banner.name, date: new Date().toLocaleString() })));

        saveState();
        updateStatsUI();
        updatePityUI(banner);
        displayResults(results);
      };
      
      const handleReset = () => {
        // if (!confirm('정말로 모든 기록을 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
        gachaState = {
            totalSpent: 0,
            history: [],
            stats: {
                "교대 핫라인": { total: 0, star6: 0, star5: 0, star4: 0, star3: 0 },
                "영구 핫라인": { total: 0, star6: 0, star5: 0, star4: 0, star3: 0 },
            },
            pity: {
              "교대 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
              "영구 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
            }
        };
        saveState();
        updateStatsUI();
        const selectedBannerKey = localStorage.getItem('selectedBannerKey');
        if (selectedBannerKey && bannerData) {
            updatePityUI(bannerData[selectedBannerKey]);
        }
        document.querySelector('.gacha-results__grid').innerHTML = '';
      };
      
      const showHistory = () => {
        const popup = document.querySelector('.history-popup');
        const list = document.querySelector('.history-popup__list');
        list.innerHTML = ''; // Clear previous items

        if (gachaState.history.length === 0) {
            const noHistoryMsg = document.createElement('p');
            noHistoryMsg.className = 'history-popup__item';
            noHistoryMsg.textContent = '통신 기록이 없습니다.';
            list.appendChild(noHistoryMsg);
        } else {
            const fragment = document.createDocumentFragment();
            gachaState.history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-popup__item';

                const icon = document.createElement('img');
                icon.src = `./img/character/${item.id}/icon.png`;
                icon.alt = item.name;
                icon.className = `history-popup__icon history-popup__icon--star-${item.rare.replace('star', '')}`;

                const details = document.createElement('div');
                details.className = 'history-popup__item-details';

                const name = document.createElement('span');
                name.className = `name name--${item.rare}`;
                name.textContent = item.name;
                
                const info = document.createElement('span');
                info.className = 'info';
                info.textContent = ` [${item.rare.replace('star', '')}★] ${item.banner} (${item.date})`;

                details.appendChild(name);
                details.appendChild(info);
                
                historyItem.appendChild(icon);
                historyItem.appendChild(details);
                fragment.appendChild(historyItem);
            });
            list.appendChild(fragment);
        }
        
        popup.classList.remove('history-popup--closed');
      };

      (async () => {
        try {
          const [bannerResponse, characterResponse] = await Promise.all([
            fetch('banner.json'),
            fetch('character.json')
          ]);
          const banners = await bannerResponse.json();
          const characters = await characterResponse.json();

          bannerData = banners;
          characterMap = new Map(characters.map(char => [char.id, char]));

          loadState(); 
          updateStatsUI();

          const buttonContainer = document.querySelector('.banner-selector');
          
          const showBanner = (bannerKey) => {
            const banner = bannerData[bannerKey];
            if (!banner) return;
            
            document.querySelector('.gacha-results__grid').innerHTML = '';

            document.querySelector('.banner-info__type').textContent = `[ ${banner.type} ]`;
            document.querySelector('.banner-info__name').textContent = banner.name;
            
            document.querySelectorAll('.banner-selector__button').forEach(btn => btn.classList.remove('banner-selector__button--active'));
            document.querySelector(`.banner-selector__button[data-banner-key="${bannerKey}"]`).classList.add('banner-selector__button--active');
            
            localStorage.setItem('selectedBannerKey', bannerKey);
            
            updatePityUI(banner);
          };

          for (const bannerKey in bannerData) {
            const banner = bannerData[bannerKey];
            const button = document.createElement('button');
            button.className = 'banner-selector__button';
            button.dataset.bannerKey = bannerKey; 
            
            const img = document.createElement('img');
            img.className = 'banner-selector__image';
            img.src = banner.img;
            img.alt = banner.name;

            button.appendChild(img);
            
            button.addEventListener('click', () => {
              showBanner(bannerKey);
            });

            buttonContainer.appendChild(button);
          }

          const savedBannerKey = localStorage.getItem('selectedBannerKey');
          const initialBannerKey = (savedBannerKey && bannerData[savedBannerKey]) 
                                    ? savedBannerKey 
                                    : Object.keys(bannerData)[0];

          if (initialBannerKey) {
            showBanner(initialBannerKey);
          }
          
          document.querySelector('.js-draw-1').addEventListener('click', () => handleDraw(1));
          document.querySelector('.js-draw-10').addEventListener('click', () => handleDraw(10));
          
          document.querySelector('.js-show-history').addEventListener('click', showHistory);
          document.querySelector('.js-reset').addEventListener('click', handleReset);
          document.querySelector('.history-popup__close-button').addEventListener('click', () => {
            document.querySelector('.history-popup').classList.add('history-popup--closed');
          });

        } catch (error) {
          console.error("오류가 발생했습니다:", error);
          document.querySelector('.gacha-area').textContent = '데이터를 불러오는 데 실패했습니다.';
        }
      })();
    </script>
  </body>
</html>