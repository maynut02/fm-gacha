<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <title>신월동행 가챠 시뮬레이터</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="banner-selector"></div>
    <main>
      <div class="sidebar">
        <div class="banner-info">
          <div>
            <div class="banner-info__type"></div>
            <h2 class="banner-info__name"></h2>
          </div>
          <div class="stats-panel">
            <span style="font-weight: 700; padding-bottom: 6px;">통계</span>
            <div class="stats-panel__card">
              <span>누적 소모 월상석 가루</span>
              <div class="js-total-spent">
                <img src="./img/pqia4y.png" height="20px"> 0
              </div>
            </div>
            <hr class="stats-panel__divider">
            <div class="stats-panel__card js-stats-rotation">
              <span style="font-weight: 700; text-align: center;">교대 핫라인</span>
              <span>총 영입 횟수: 0</span>
              <span><span class="text-rarity-star6">6★</span>: 0 (픽업: 0)</span>
              <span><span class="text-rarity-star5">5★</span>: 0</span>
              <span><span class="text-rarity-star4">4★</span>: 0</span>
              <span><span class="text-rarity-star3">3★</span>: 0</span>
            </div>
            <hr class="stats-panel__divider">
            <div class="stats-panel__card js-stats-permanent">
              <span style="font-weight: 700; text-align: center;">영구 핫라인</span>
              <span>총 영입 횟수: 0 </span>
              <span><span class="text-rarity-star6">6★</span>: 0 (픽업: 0)</span>
              <span><span class="text-rarity-star5">5★</span>: 0</span>
              <span><span class="text-rarity-star4">4★</span>: 0</span>
              <span><span class="text-rarity-star3">3★</span>: 0</span>
            </div>
          </div>
          <div>
            <div class="stats-panel__actions">
              <button class="stats-panel__button js-toggle-details">상세정보</button>
              <button class="stats-panel__button js-reset">초기화</button>
            </div>
            <div class="stats-panel__actions">
              <button class="stats-panel__button js-toggle-history">통신 기록</button>
            </div>
          </div>
        </div>
      </div>
      <div class="gacha-area">
        <div class="gacha-area__container">
          <div class="pity-tracker">
            <span class="js-pity-6">70회 확정: 6성 특수 요원 (픽업 특수 요원)</span>
            <span class="js-pity-5">10회 확정: 5성 이상의 특수 요원</span>
          </div>
          <div class="gacha-results">
            <div class="gacha-results__grid"></div>
          </div>
          <div class="draw-controls">
            <button class="draw-controls__button js-draw-1">
              영입 1회
              <div class="draw-controls__cost"><img src="./img/pqia4y.png" alt="월상석" height="16px">x160</div>
            </button>
            <button class="draw-controls__button js-draw-10">
              영입 10회
              <div class="draw-controls__cost"><img src="./img/pqia4y.png" alt="월상석" height="16px">x1600</div>
            </button>
          </div>
        </div>
        <div class="history-area__container hidden"></div>
        <div class="detail-area__container hidden"></div>
      </div>
    </main>
    
    <script>
      let bannerData;
      let characterMap;

      let gachaState = {
        totalSpent: 0,
        history: [], 
        stats: {
          "교대 핫라인": { total: 0, star6: 0, star6_pickup: 0, star5: 0, star4: 0, star3: 0 },
          "영구 핫라인": { total: 0, star6: 0, star6_pickup: 0, star5: 0, star4: 0, star3: 0 },
        },
        pity: {
          "교대 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
          "영구 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
        }
      };

      const loadState = () => {
        const savedState = localStorage.getItem('gachaState');
        if (savedState) {
          let loaded = JSON.parse(savedState);
          if (!loaded.pity) {
            loaded.pity = {
              "교대 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
              "영구 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
            };
          } else {
            for (const key in loaded.pity) {
              if (loaded.pity[key].guaranteedPickup === undefined) {
                loaded.pity[key].guaranteedPickup = false;
              }
            }
          }
          gachaState = loaded;
        }
      };

      const saveState = () => {
        localStorage.setItem('gachaState', JSON.stringify(gachaState));
      };

      const updateStatsUI = () => {
        document.querySelector('.js-total-spent').innerHTML = `<img src="./img/pqia4y.png" height="20px"> ${gachaState.totalSpent}`;
        
        const rotationStats = gachaState.stats["교대 핫라인"];
        const rotationPanel = document.querySelector('.js-stats-rotation');
        rotationPanel.children[1].textContent = `총 영입 횟수: ${rotationStats.total}`;
        rotationPanel.children[2].innerHTML = `<span class="text-rarity-star6">6★</span>: ${rotationStats.star6} (픽업: ${rotationStats.star6_pickup || 0})`;
        // rotationPanel.children[3].textContent = `(픽업: ${rotationStats.star6_pickup || 0})`;
        rotationPanel.children[3].innerHTML = `<span class="text-rarity-star5">5★</span>: ${rotationStats.star5}`;
        rotationPanel.children[4].innerHTML = `<span class="text-rarity-star4">4★</span>: ${rotationStats.star4}`;
        rotationPanel.children[5].innerHTML = `<span class="text-rarity-star3">3★</span>: ${rotationStats.star3}`;

        const permanentStats = gachaState.stats["영구 핫라인"];
        const permanentPanel = document.querySelector('.js-stats-permanent');
        permanentPanel.children[1].textContent = `총 영입 횟수: ${permanentStats.total}`;
        permanentPanel.children[2].innerHTML = `<span class="text-rarity-star6">6★</span>: ${permanentStats.star6} (픽업: ${permanentStats.star6_pickup || 0})`;
        // permanentPanel.children[3].textContent = `(픽업: ${permanentStats.star6_pickup || 0})`;
        permanentPanel.children[3].innerHTML = `<span class="text-rarity-star5">5★</span>: ${permanentStats.star5}`;
        permanentPanel.children[4].innerHTML = `<span class="text-rarity-star4">4★</span>: ${permanentStats.star4}`;
        permanentPanel.children[5].innerHTML = `<span class="text-rarity-star3">3★</span>: ${permanentStats.star3}`;
      };

      const updatePityUI = (banner) => {
        if (!banner) return;
        const pityCounters = gachaState.pity[banner.type];
        const pity6El = document.querySelector('.js-pity-6');
        const pity5El = document.querySelector('.js-pity-5');
        
        const pullsTo6Star = 70 - pityCounters.pity6Star;
        const pullsTo5Star = 10 - pityCounters.pity5Star;

        let guaranteedText = (pityCounters.guaranteedPickup && banner.pickup?.star6) ? " (픽업 특수 요원 확정)" : "";
        pity6El.textContent = `${pullsTo6Star}회 확정: 6성 특수 요원${guaranteedText}`;
        pity5El.textContent = `${pullsTo5Star}회 확정: 5성 이상의 특수 요원`;
      };

      const displayResults = (results) => {
        const gachaContainer = document.querySelector('.gacha-results__grid');
        gachaContainer.innerHTML = '';
        
        results.forEach(char => {
          const charDiv = document.createElement('div');
          charDiv.className = `result-card rarity-star${char.rare.slice(-1)}`;
          
          const img = document.createElement('img');
          img.className = 'result-card__image';
          img.src = `./img/character/${char.id}/0.png`; 
          img.alt = char.name;

          const nameSpan = document.createElement('span');
          nameSpan.className = 'result-card__name';
          nameSpan.textContent = char.name;
          
          charDiv.appendChild(img);
          charDiv.appendChild(nameSpan);
          gachaContainer.appendChild(charDiv);
        });
      };

      const performSingleDraw = (banner, currentPity) => {
        const poolsByRarity = { star6: [], star5: [], star4: [], star3: [] };
        banner.pool.forEach(id => {
          const char = characterMap.get(id);
          if (char && poolsByRarity[char.rare]) {
            poolsByRarity[char.rare].push(id);
          }
        });

        let rarity;
        const pity5Threshold = (Math.random() < banner.rates.star6 / (banner.rates.star6 + banner.rates.star5)) ? 'star6' : 'star5'; 
        if (currentPity.pity6Star >= 69) {
          rarity = 'star6';
        } else if (currentPity.pity5Star >= 9) {
          rarity = pity5Threshold;
        } else {
          const base6Rate = banner.rates.star6 / 100;
          const increasedRate = base6Rate + Math.max(0, currentPity.pity6Star - 50) * base6Rate * 2;
          const rand = Math.random();

          if (rand < increasedRate) rarity = 'star6';
          else if (rand < increasedRate + banner.rates.star5 / 100) rarity = 'star5';
          else if (rand < increasedRate + banner.rates.star5 / 100 + banner.rates.star4 / 100) rarity = 'star4';
          else rarity = 'star3';
        }
        
        let finalCharId;
        const pickup = banner.pickup;
        const hasPickup = pickup && typeof pickup === 'object';
        
        if (rarity === 'star6' && hasPickup && pickup.star6) {
            const pickupId = pickup.star6;
          if (currentPity.guaranteedPickup) {
            finalCharId = pickupId;
          } else {
            if (Math.random() < 0.5) {
              finalCharId = pickupId;
            } else {
              const nonPickupPool = poolsByRarity.star6.filter(id => id !== pickupId);
              finalCharId = nonPickupPool.length > 0 ? nonPickupPool[Math.floor(Math.random() * nonPickupPool.length)] : pickupId;
            }
          }
        } else if (rarity === 'star5' && hasPickup && pickup.star5 && pickup.star5.length > 0) {
            const pickupIds = pickup.star5;
          if (Math.random() < 0.5) {
            finalCharId = pickupIds[Math.floor(Math.random() * pickupIds.length)];
          } else {
            const nonPickupPool = poolsByRarity.star5.filter(id => !pickupIds.includes(id));
            finalCharId = nonPickupPool.length > 0 ? nonPickupPool[Math.floor(Math.random() * nonPickupPool.length)] : (pickupIds[0] || poolsByRarity.star5[0]);
          }
        } 
        
        if (!finalCharId) {
          const targetPool = poolsByRarity[rarity];
          if(targetPool && targetPool.length > 0) {
            finalCharId = targetPool[Math.floor(Math.random() * targetPool.length)];
          } else {
            const anyPool = banner.pool;
            finalCharId = anyPool[Math.floor(Math.random() * anyPool.length)];
          }
        }
        
        return characterMap.get(finalCharId) || { id: 0, name: '데이터 없음', rare: 'star3' };
      };

      const handleDraw = (count) => {
        const selectedBannerKey = localStorage.getItem('selectedBannerKey');
        if (!selectedBannerKey || !bannerData[selectedBannerKey]) {
          alert("배너를 먼저 선택해주세요.");
          return;
        }

        const banner = bannerData[selectedBannerKey];
        const pityCounters = gachaState.pity[banner.type];
        const results = [];
        
        for (let i = 0; i < count; i++) {
          pityCounters.pity5Star++;
          pityCounters.pity6Star++;
          
          const character = performSingleDraw(banner, pityCounters);
          results.push(character);
          
          const bannerTypeStats = gachaState.stats[banner.type];
          bannerTypeStats.total++;
          bannerTypeStats[character.rare]++;
          gachaState.totalSpent += 160;

          if (character.rare === 'star6') {
            pityCounters.pity5Star = 0;
            pityCounters.pity6Star = 0;
            if (banner.pickup?.star6) {
              pityCounters.guaranteedPickup = character.id !== banner.pickup.star6;

              if (character.id === banner.pickup.star6) {
                if (!bannerTypeStats.star6_pickup) {
                    bannerTypeStats.star6_pickup = 0;
                }
                bannerTypeStats.star6_pickup++;
              }
            }
          } else if (character.rare === 'star5') {
            pityCounters.pity5Star = 0;
          }
        }
        
        const newHistoryGroup = {
          pulls: results,
          date: new Date().toLocaleString(),
          bannerName: banner.name,
          bannerType: banner.type
        };
        gachaState.history.unshift(newHistoryGroup);

        saveState();
        updateStatsUI();
        updatePityUI(banner);
        displayResults(results);
      };
      
      const handleReset = () => {
        gachaState = {
          totalSpent: 0,
          history: [],
          stats: {
            "교대 핫라인": { total: 0, star6: 0, star6_pickup: 0, star5: 0, star4: 0, star3: 0 },
            "영구 핫라인": { total: 0, star6: 0, star6_pickup: 0, star5: 0, star4: 0, star3: 0 },
          },
          pity: {
            "교대 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
            "영구 핫라인": { pity5Star: 0, pity6Star: 0, guaranteedPickup: false },
          }
        };
        saveState();
        updateStatsUI();
        const selectedBannerKey = localStorage.getItem('selectedBannerKey');
        if (selectedBannerKey && bannerData) {
          updatePityUI(bannerData[selectedBannerKey]);
        }
        document.querySelector('.gacha-results__grid').innerHTML = '';
        renderHistory();
      };
      
      const renderHistory = () => {
        const historyContainer = document.querySelector('.history-area__container');
        historyContainer.innerHTML = '';

        if (!gachaState.history || gachaState.history.length === 0) {
          const noHistoryMsg = document.createElement('p');
          noHistoryMsg.textContent = '통신 기록이 없습니다.';
          historyContainer.appendChild(noHistoryMsg);
          return;
        }
        
        const fragment = document.createDocumentFragment();
        gachaState.history.forEach(group => {
          if (!group.pulls) return; 

          const groupDiv = document.createElement('div');
          groupDiv.className = 'history-group';
          
          const infoDiv = document.createElement('div');
          infoDiv.className = 'history-group__info';
          
          infoDiv.innerHTML = `
            <span>${group.date}</span>
            <span>[${group.bannerType}]</span>
            <span>${group.bannerName}</span>
          `;

          const mainDiv = document.createElement('div');
          mainDiv.className = 'history-group__main';
          
          group.pulls.forEach(char => {
            const icon = document.createElement('img');
            icon.className = `history-group__icon rarity-star${char.rare.slice(-1)}`;
            icon.src = `./img/character/${char.id}/icon.png`;
            icon.alt = char.name;
            icon.title = `${char.name} (${char.rare.replace('star', '')}★)`;
            mainDiv.appendChild(icon);
          });
          
          groupDiv.appendChild(infoDiv);
          groupDiv.appendChild(mainDiv);
          fragment.appendChild(groupDiv);
        });
        historyContainer.appendChild(fragment);
      };

      const renderDetails = () => {
        const detailContainer = document.querySelector('.detail-area__container');
        const selectedBannerKey = localStorage.getItem('selectedBannerKey');
        const banner = bannerData[selectedBannerKey];

        if (!banner) {
          detailContainer.innerHTML = '<p>표시할 배너 정보를 선택해주세요.</p>';
          return;
        }

        const pool = { star6: [], star5: [], star4: [], star3: [] };
        banner.pool.forEach(id => {
          const char = characterMap.get(id);
          if (char && pool[char.rare]) {
            pool[char.rare].push(char.name);
          }
        });
        
        const createCharListHTML = (arr) => arr.map(name => `<span>${name}</span>`).join('');
        
        if (banner.type === '교대 핫라인') {
          const star6PickupId = banner.pickup?.star6;
          const star6PickupChar = characterMap.get(star6PickupId) || { id: 0, name: '없음' };
          const star5PickupIds = banner.pickup?.star5 || [];
          const star5PickupChars = star5PickupIds.map(id => characterMap.get(id)).filter(Boolean);
          while (star5PickupChars.length < 2) {
            star5PickupChars.push({ id: 0, name: '' });
          }
          const star5PickupNames = star5PickupChars.map(p => p.name).filter(Boolean);

          // 교대 핫라인 설명
          detailContainer.innerHTML = `
            <div class="detail-section">
              <div class="detail-rateup-list">
                <div class="detail-rateup-list__item">
                  <img src="./img/character/${star6PickupChar.id}/icon.png" alt="${star6PickupChar.name}">
                  <span class="text-rarity-star6">${star6PickupChar.name}</span>
                </div>
                <div class="detail-rateup-list__item">
                  <img src="./img/character/${star5PickupChars[0].id}/icon.png" alt="${star5PickupChars[0].name}">
                  <span class="text-rarity-star5">${star5PickupChars[0].name}</span>
                </div>
                <div class="detail-rateup-list__item">
                  <img src="./img/character/${star5PickupChars[1].id}/icon.png" alt="${star5PickupChars[1].name || ''}">
                  <span class="text-rarity-star5">${star5PickupChars[1].name || ''}</span>
                </div>
              </div>
            </div>
            <div class="detail-section">
              <h3 class="detail-section__title">▸ 영입 확률 설명</h3>
              <p>이번 시즌 영입 <span style="color: orange;">${banner.name}</span>에서 각 희귀 특수 요원의 영입 확률은 다음과 같습니다.</p>
              <ul>
                <li>「<span class="text-rarity-star6">6★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star6}%</span>로, 천장 메커니즘을 포함한 종합 확률은 <span style="color: orange;">2.39%</span>입니다. 이 중 <span class="text-rarity-star6">${star6PickupChar.name}</span>의 영입 확률이 증가하며 6성 특수 요원 영입 확률의 50%를 차지합니다.</li>
                <li>「<span class="text-rarity-star5">5★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star5}%</span>입니다. 이 중 <span class="text-rarity-star5">${star5PickupNames.join(', ')}</span>의 영입 확률이 증가하며 5성 특수 요원 영입 확률의 <span style="color: orange;">50%</span>를 차지합니다.</li>
                <li>「<span class="text-rarity-star4">4★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star4}%</span>입니다.</li>
                <li>「<span class="text-rarity-star3">3★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star3}%</span>입니다.</li>
              </ul>
              <hr class="stats-panel__divider">
              <p><span class="text-rarity-star6">6★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star6)}</div>
              <p><span class="text-rarity-star5">5★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star5)}</div>
              <p><span class="text-rarity-star4">4★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star4)}</div>
              <p><span class="text-rarity-star3">3★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star3)}</div>
            </div>
            <div class="detail-section">
              <h3 class="detail-section__title">▸ <span style="color: orange;">「${banner.type}」</span> 설명</h3>
              <ul>
                <li>이번 시즌 영입 유형은 <span style="color: orange;">${banner.type}</span>입니다.</li>
                <li>이번 시즌 영입에서 10번마다 <span style="color: orange;">반드시</span> 1명의 5성 혹은 그를 초과하는 특수 요원을 획득합니다.</li>
                <li>6성 특수 요원을 연속된 여러 차례의 영입에서 획득하지 못하면 6성 특수 요원의 획득 확률이 점진적으로 증가하며 최대 <span style="color: orange;">70</span>회 영입에서 천장 메커니즘으로 6성 특수 요원을 반드시 획득할 수 있습니다.</li>
                <li>이번 영입에서 획득한 6성 특수 요원이 영입 확률 증가 특수 요원이 아니라면 다음 영입으로 획득하는 6성 특수 요원은 <span style="color: orange;">반드시</span> 영입 확률 증가 특수 요원이 됩니다.</li>
                <li>임의의 <span style="color: orange;">「${banner.type}」</span>에서 6성 특수 요원을 획득하지 못하면 천장 횟수가 누적되며 6성 특수 요원을 획득한 후 초기화됩니다. 해당 횟수는 모든 <span style="color: orange;">「${banner.type}」</span>에서 공유됩니다.</li>
              </ul>
            </div>
          `;
        } else {
          // 영구 핫라인 설명
          detailContainer.innerHTML = `
            <div class="detail-section">
              <h3 class="detail-section__title">▸ 영입 확률 설명</h3>
              <p>이번 시즌 <span style="color: orange;">${banner.name}</span>에서 각 희귀 특수 요원의 영입 확률은 다음과 같습니다.</p>
              <ul>
                <li>「<span class="text-rarity-star6">6★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star6}%</span>로, 천장 메커니즘을 포함한 종합 확률은 <span style="color: orange;">2.39%</span>입니다.</li>
                <li>「<span class="text-rarity-star5">5★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star5}%</span>입니다.</li>
                <li>「<span class="text-rarity-star4">4★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star4}%</span>입니다.</li>
                <li>「<span class="text-rarity-star3">3★</span> 특수 요원」의 기본 확률은 <span style="color: orange;">${banner.rates.star3}%</span>입니다.</li>
              </ul>
              <hr class="stats-panel__divider">
              <p><span class="text-rarity-star6">6★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star6)}</div>
              <p><span class="text-rarity-star5">5★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star5)}</div>
              <p><span class="text-rarity-star4">4★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star4)}</div>
              <p><span class="text-rarity-star3">3★ 특수 요원</span></p>
              <div class="detail-char-list">${createCharListHTML(pool.star3)}</div>
            </div>
            <div class="detail-section">
              <h3 class="detail-section__title">▸ <span style="color: orange;">「${banner.type}」</span> 설명</h3>
              <ul>
                <li>이번 시즌 영입 유형은 <span style="color: orange;">${banner.type}</span>입니다.</li>
                <li>6성 특수 요원을 연속된 여러 차례의 통신에서 획득하지 못하면 6성 특수 요원의 획득 확률이 점진적으로 증가하며 최대 <span style="color: orange;">70</span>회 통신에서 천장 메커니즘으로 6성 특수 요원을 반드시 획득할 수 있습니다.</li>
                <li>임의의 <span style="color: orange;">「${banner.type}」</span>에서 6성 특수 요원을 획득하지 못하면 천장 횟수가 누적되며 6성 특수 요원을 획득한 후 초기화됩니다</li>
              </ul>
            </div>
          `;
        }
      };


      (async () => {
        try {
          const gachaContainer = document.querySelector('.gacha-area__container');
          const historyContainer = document.querySelector('.history-area__container');
          const detailContainer = document.querySelector('.detail-area__container');
          
          const toggleHistoryButton = document.querySelector('.js-toggle-history');
          const toggleDetailsButton = document.querySelector('.js-toggle-details');
          
          const bannerContainer = document.querySelector('.banner-selector');

          const [bannerResponse, characterResponse] = await Promise.all([
            fetch('banner.json'),
            fetch('character.json')
          ]);
          
          const characters = await characterResponse.json();
          bannerData = await bannerResponse.json();
          characterMap = new Map(characters.map(char => [char.id, char]));

          loadState(); 
          updateStatsUI();
          
          let currentView = 'gacha';

          const showBanner = (bannerKey) => {
            const banner = bannerData[bannerKey];
            if (!banner) return;
            
            document.querySelector('.gacha-results__grid').innerHTML = '';
            document.querySelector('.banner-info__type').textContent = `[ ${banner.type} ]`;
            document.querySelector('.banner-info__name').textContent = banner.name;
            
            document.querySelectorAll('.banner-selector__button').forEach(btn => btn.classList.remove('banner-selector__button--active'));
            document.querySelector(`.banner-selector__button[data-banner-key="${bannerKey}"]`).classList.add('banner-selector__button--active');
            
            localStorage.setItem('selectedBannerKey', bannerKey);
            
            updatePityUI(banner);

            if (currentView === 'details') {
              renderDetails();
            }
          };

          for (const bannerKey in bannerData) {
            const banner = bannerData[bannerKey];
            const button = document.createElement('button');
            button.className = 'banner-selector__button';
            button.dataset.bannerKey = bannerKey; 
            
            const img = document.createElement('img');
            img.className = 'banner-selector__image';
            img.src = banner.img;
            img.alt = banner.name;

            button.appendChild(img);
            
            button.addEventListener('click', () => showBanner(bannerKey));
            bannerContainer.appendChild(button);
          }
          
          const savedBannerKey = localStorage.getItem('selectedBannerKey');
          const initialBannerKey = (savedBannerKey && bannerData[savedBannerKey]) 
                                    ? savedBannerKey 
                                    : Object.keys(bannerData)[0];

          if (initialBannerKey) {
            showBanner(initialBannerKey);
          }

          const setView = (viewName) => {
            currentView = viewName;
            
            gachaContainer.classList.add('hidden');
            historyContainer.classList.add('hidden');
            detailContainer.classList.add('hidden');

            toggleHistoryButton.textContent = '통신 기록';
            toggleDetailsButton.textContent = '상세정보';

            if (viewName === 'gacha') {
              gachaContainer.classList.remove('hidden');
            } else if (viewName === 'history') {
              historyContainer.classList.remove('hidden');
              toggleHistoryButton.textContent = '통신 기록 닫기';
              renderHistory();
            } else if (viewName === 'details') {
              detailContainer.classList.remove('hidden');
              toggleDetailsButton.textContent = '상세정보 닫기';
              renderDetails();
            }
          }

          const handleHistoryToggle = () => {
            setView(currentView === 'history' ? 'gacha' : 'history');
          };
          
          const handleDetailsToggle = () => {
            setView(currentView === 'details' ? 'gacha' : 'details');
          };
          
          document.querySelector('.js-draw-1').addEventListener('click', () => handleDraw(1));
          document.querySelector('.js-draw-10').addEventListener('click', () => handleDraw(10));
          document.querySelector('.js-reset').addEventListener('click', handleReset);
          toggleHistoryButton.addEventListener('click', handleHistoryToggle);
          toggleDetailsButton.addEventListener('click', handleDetailsToggle);

        } catch (error) {
          console.error("오류가 발생했습니다:", error);
          document.querySelector('.gacha-area').textContent = '데이터를 불러오는 데 실패했습니다.';
        }
      })();
    </script>
  </body>
</html>